#! /usr/bin/env nix-shell
#! nix-shell -i bash -p bat gawk jq ncurses niv

# This script will update all of the sources.json files generated by niv

shpid="$$"
green="$(tput setaf 2)"
yellow="$(tput setaf 3)"
white="$(tput setaf 7)"
reset="$(tput sgr 0)"
bold="$(tput bold)"
hide="$(tput civis)"
norm="$(tput cnorm)"
chars="/-\|"
pwd="$PWD"

echo -en "$hide"
find -L "$(pwd)/" -type f -name "update-sources.sh" | while read -r updatescript; do
  (
    dir="$(dirname -- "$updatescript")"
    md5="$(md5sum <<<"$dir" | awk '{print $1}')"
    cd "$dir" || exit
    niv show > "/tmp/$md5"
    (
      TEMP="$(mktemp)"
      $updatescript > "$TEMP" &

      relpath="$(realpath -s --relative-to="$pwd" "$updatescript")"

      while [[ -d /proc/"$!" ]]; do
        for (( i=0; i<${#chars}; i++ )); do
          sleep 0.075
          echo -en "[$green${chars:$i:1}$reset]$white Running $bold$green$relpath$reset..." "\r"
        done
      done

      echo -e "\n$(<"$TEMP")\n"
      rm "$TEMP"

      fn="$(realpath --relative-to="$pwd" ./nix/sources.json)"
      diff -u --label="a/$fn" "/tmp/$md5" --label="b/$fn" <(niv show) >> "/tmp/$shpid.diff"
      rm "/tmp/$md5"
    )
  )
done

echo -en "$bold$yellow"Updated sources:"$reset\n"
bat --theme=base16 --paging=never -p "/tmp/$shpid.diff"
echo -en "$norm"

if [[ -s "/tmp/$shpid.diff" ]]; then
  while true; do
    read -p "Do you wish to install the above updates? [Y/n] " yn
    case $yn in
        [Yy*] ) ./install.sh
        break;;
        [Nn]* ) exit
        ;;
        * ) ./install.sh
        break;;
    esac
  done
fi
rm "/tmp/$shpid.diff"

